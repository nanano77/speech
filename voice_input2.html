<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>èªéŸ³éŒ„éŸ³ä¸Šå‚³è¾¨è­˜ï¼ˆdebug ç‰ˆï¼‰</title>
  <style>
    body { font-family: sans-serif; padding: 2em; }
    .chatbox { display: flex; align-items: center; gap: 1em; }
    button { padding: 0.5em 1em; font-size: 1em; }
    #status { margin-top: 1em; color: darkred; }
  </style>
</head>
<body>
  <h2>ğŸ¤ éŒ„éŸ³èªéŸ³è¼¸å…¥ï¼ˆæ”¯æ´æ‰‹æ©Ÿã€debugæ¨¡å¼ï¼‰</h2>
  <div class="chatbox">
    <button id="startBtn">é–‹å§‹éŒ„éŸ³</button>
    <button id="stopBtn" disabled>åœæ­¢éŒ„éŸ³</button>
  </div>
  <p id="status"></p>
  <p><strong>è¾¨è­˜çµæœï¼š</strong><span id="result">ï¼ˆå°šæœªè¾¨è­˜ï¼‰</span></p>
  <div id="download"></div>

  <script>
    window.onload = () => {
      const startBtn = document.getElementById('startBtn');
      const stopBtn = document.getElementById('stopBtn');
      const status = document.getElementById('status');
      const result = document.getElementById('result');
      const download = document.getElementById('download');

      let mediaRecorder;
      let audioChunks = [];

      startBtn.onclick = async () => {
        alert("âœ… é»æ“Šäº†é–‹å§‹éŒ„éŸ³æŒ‰éˆ•");

        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
          alert("âŒ éŒ¯èª¤ï¼šä½ çš„ç€è¦½å™¨ä¸æ”¯æ´éŒ„éŸ³åŠŸèƒ½");
          return;
        }

        try {
          alert("ğŸ™ï¸ å˜—è©¦å–å¾—éº¥å…‹é¢¨...");
          const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
          alert("âœ… å·²æˆæ¬Šéº¥å…‹é¢¨ï¼é–‹å§‹éŒ„éŸ³");

          mediaRecorder = new MediaRecorder(stream);
          audioChunks = [];

          mediaRecorder.ondataavailable = (e) => {
            if (e.data.size > 0) audioChunks.push(e.data);
          };

          mediaRecorder.onstop = async () => {
            alert("ğŸ›‘ éŒ„éŸ³çµæŸ");
            const blob = new Blob(audioChunks, { type: 'audio/webm' });

            // é¡¯ç¤ºä¸‹è¼‰é€£çµ
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'recording.webm';
            a.textContent = 'ğŸ§ é»æ­¤ä¸‹è¼‰éŒ„éŸ³æª”æ¡ˆ';
            download.innerHTML = ''; // æ¸…ç©ºèˆŠçš„
            download.appendChild(a);

            // ä¸Šå‚³è¾¨è­˜
            const formData = new FormData();
            formData.append('audio', blob, 'recording.webm');
            status.textContent = 'â¬†ï¸ ä¸Šå‚³ä¸­...';

            try {
              const res = await fetch('https://0da1-2401-e180-88b0-d44a-a04f-2df1-d14e-3af7.ngrok-free.app/recognize', {
                method: 'POST',
                body: formData
              });

              const json = await res.json();
              result.textContent = json.text || '(ç„¡æ³•è¾¨è­˜)';
              status.textContent = 'âœ… å®Œæˆè¾¨è­˜';
            } catch (err) {
              console.error('ä¸Šå‚³æˆ–è¾¨è­˜éŒ¯èª¤ï¼š', err);
              status.textContent = 'âŒ ä¸Šå‚³æˆ–è¾¨è­˜å¤±æ•—';
              alert("âš ï¸ ç„¡æ³•é€£ç·šå¾Œç«¯ï¼š" + err.message);
            }
          };

          mediaRecorder.start();
          status.textContent = 'ğŸ™ï¸ éŒ„éŸ³ä¸­...';
          startBtn.disabled = true;
          stopBtn.disabled = false;
        } catch (err) {
          console.error('éŒ„éŸ³å•Ÿå‹•éŒ¯èª¤ï¼š', err);
          alert("âŒ éŒ¯èª¤ï¼š" + err.message);
        }
      };

      stopBtn.onclick = () => {
        if (mediaRecorder && mediaRecorder.state === "recording") {
          mediaRecorder.stop();
          startBtn.disabled = false;
          stopBtn.disabled = true;
          status.textContent = 'â¹ï¸ åœæ­¢éŒ„éŸ³ï¼Œæº–å‚™è¾¨è­˜...';
        }
      };
    };
  </script>
</body>
</html>
