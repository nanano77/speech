<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>å¤šå¹³å°èªéŸ³è¾¨è­˜ï¼ˆå³æ™‚ä¸Šå‚³ï¼‰</title>
  <style>
    body { font-family: sans-serif; padding: 2em; }
    button { padding: 1em 2em; font-size: 1em; }
    #log { margin-top: 1em; font-size: 1.2em; white-space: pre-line; border: 1px solid #ccc; padding: 1em; min-height: 5em; }
  </style>
</head>
<body>
  <h2>ğŸ¤ å³æ™‚èªéŸ³è¼¸å…¥ï¼ˆå¤šå¹³å° Whisper è¾¨è­˜ï¼‰</h2>
  <button id="startBtn">é–‹å§‹è¾¨è­˜</button>
  <button id="stopBtn" disabled>åœæ­¢</button>
  <div id="log">å°šæœªé–‹å§‹</div>

  <script>
    const startBtn = document.getElementById("startBtn");
    const stopBtn = document.getElementById("stopBtn");
    const log = document.getElementById("log");

    let mediaRecorder;
    let interval;
    let stream;

    let resultText = "";

    startBtn.onclick = async () => {
      log.textContent = "ğŸ§ é–‹å§‹éŒ„éŸ³è¾¨è­˜...";
      stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      mediaRecorder = new MediaRecorder(stream);

      mediaRecorder.ondataavailable = async (e) => {
        if (e.data.size > 0) {
          const formData = new FormData();
          formData.append("audio", e.data, "chunk.webm");

          try {
            const res = await fetch("http://localhost:5000/recognize", {
              method: "POST",
              body: formData,
            });

            const json = await res.json();
            if (json.text) {
              resultText += json.text;
              log.textContent = resultText;
            }
          } catch (err) {
            console.error("è¾¨è­˜å¤±æ•—", err);
          }
        }
      };

      mediaRecorder.start();
      interval = setInterval(() => {
        mediaRecorder.requestData(); // æ¯ 1 ç§’å¼·åˆ¶åˆ‡ç‰‡ä¸€æ¬¡
      }, 1000);

      startBtn.disabled = true;
      stopBtn.disabled = false;
    };

    stopBtn.onclick = () => {
      mediaRecorder.stop();
      clearInterval(interval);
      stream.getTracks().forEach((t) => t.stop());
      startBtn.disabled = false;
      stopBtn.disabled = true;
      log.textContent += "\nâ¹ï¸ å·²åœæ­¢éŒ„éŸ³";
    };
  </script>
</body>
</html>
